# Camera

The camera module supports image input with readily available camera modules and devices. The API is based on the current draft of `ImageIn` class expected to be part of the 3rd Edition of the ECMA-419 standard.

There are a number of ESP32-S3 devices which integrate a camera and include PSRAM. We've tried, and included target platforms for the following devices:

- `m5atom_s3r`: This small camera has no display, so the server applications will be of interest. There are two versions of this device. The smaller device has a GC0308 camera sensor. The M12 version has an OV3660 camera sensor which supports JPEG output.

- `m5stack_cores3`: This all-in-one device includes a touch-screen, battery and other sensors. It has a GC0308 camera sensor. This camera does not support JPEG output.

- `lilygo_t_cam_plus_s3`: This all-in-one device includes a touch screen and OV2640 camera which supports JPEG output.

- `xiao_esp32s3_sense`: This very small device includes an OV2640 camera which supports JPEG output. It has no display so the server applications will be of interest.

The camera module is also available in `mcsim`, the Moddable SDK simulator, on all three host platforms: macOS, Linux and Windows. The simulator supports uncompressed pixels in RGB565LE and YUV422 formats. It does not support JPEG output.

## Module

The ESP32 camera module uses the `esp32_camera` component from the [ESP Component Registry](https://moddable.com/blog/using-the-esp-component-registry/).

Considerable effort was made in both the API and implementation to maximize performance by eliminating buffer copies where ever possible. In most cases, the JavaScript code receives direct access to the internal buffer of the camera driver, avoiding any copies. Not only is this faster but it also reduces RAM use.

### Initializing the Camera

The options object passed to the camera's constructor specifies the `width`, `height`, `imageType` and `format`. Different cameras support varying frame sizes, so the camera selects the closest frame-size to match the requested `width` and `height`. After constructing the camera object, check the `width` and `height` properties of the camera instance for the actual frame size.

#### imageType

`imageType: "jpeg"` or one of the commodetto/Bitmap formats such as `Bitmap.RGB565LE` or `Bitmap.YUV422`.

Some cameras support JPEG. If you request JPEG support and the camera does not support it, it throws an error.

#### format

`buffer` or `buffer/disposable`. The examples use `buffer/disposable` to avoid copying the data. Some of the examples show to how to use `buffer` as an alternative.

### onReadable

After constructing a Camera object, you must then `start()` the camera. When an image is generated by the camera, your `onReadable()` callback is invoked. 

Call `camera.read()` to fetch a `frame`.

For disposable buffers (where the format is `buffer/disposable`), you must explicitly dispose the frame by calling its `close()` method. If you don't do this, the camera may run out of buffers and stall.

```js
const frame = camera.read();
const bitmap = new Bitmap(camera.width, camera.height, camera.imageType, frame, 0);
//... use the bitmap
frame.close();
```

## Examples

Example projects that demonstrate the use of `camera` are in [$MODDABLE/examples/io/imagein/camera/](https://github.com/Moddable-OpenSource/moddable/tree/public/examples/io/imagein/camera). The following is a summary of these examples.

### camera-test

This app uses the Piu UI framework to display on screen what the camera is capturing.

### camera-balls

This example is a new take on the classic Moddable balls app used to introduce the Piu UI framework. One of the balls displays the live video capture. Notice that the video ball has soft anti-aliased edges and that the transparent balls colorize the camera video as they move over it.

### camera-server

This app operates an HTTP server using the original Moddable SDK HTTP client. The server provides images from the camera in BMP format. It is based on the [httpserverbmp](https://github.com/Moddable-OpenSource/moddable/tree/public/examples/network/http/httpserverbmp) example. Note that the BMP image displays in Safari and Chrome but not Firefox.

Use a web browser to connect to the device to see the camera image. The connection information is displayed in the xsbug console:

```
Wi-Fi connected to "ssid"
IP address 10.0.1.58
Server ready at: http://10.0.1.58:8080
```

This example must be built with the `ssid` and `password` configuration parameters to provide the network connection parameters.

```
mcconfig -d -m -p esp32/m5atom_s3r ssid=xxx password=xxx
```

### camera-server-jpeg

Similar to the `camera-server` app, this app captures a compressed JPEG image from the camera and servers it to the connected client. This example uses the ECMA-419 HTTP server.

See the `camera-server` example for how to connect to the device from your web browser and building with the `ssid` and `password` options to `mcconfig`.

### camera-server-motion-jpeg

Similar to the `camera-server-jpeg` app, this app continually captures a compressed JPEG image from the camera and sends it to the connected client. This appears as motion image in the web browser and can achieve 20-30 FPS depending on the performance of your Wi-Fi network. This example uses the ECMA-419 HTTP server.

See the `camera-server` example for how to connect to the device from your web browser and building with the `ssid` and `password` options to `mcconfig`.
