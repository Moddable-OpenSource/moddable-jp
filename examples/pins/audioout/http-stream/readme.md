# オーディオストリーマー
Copyright 2022-2023 Moddable Tech, Inc.<BR>
改訂: 2023年8月7日

`WavStream` クラスと `SBCStream` クラスは、HTTP 経由で配信されるオーディオストリームを再生します。`WavStream` クラスは非圧縮の WAV オーディオファイルと `Audio/L16` を再生し、`SBCStream` クラスは [SBC 圧縮](https://en.wikipedia.org/wiki/SBC_%28codec%29) オーディオを再生します。SBC は主に Bluetooth で使用される低複雑度のフォーマットです。その比較的高品質でシンプルなデコーダーは、マイクロコントローラーに非常に適しています。

`WavStream` クラスと `SBCStream` クラスは共通の API を共有していますが、実装は別々です。これらは以下のモジュールを使用します：

- ECMA-419 第2版（ドラフト）の `HTTPClient`。HTTP リクエストの API 設計により、ストリーミングデータのバッファリングが非常に簡単になります。
- オーディオ再生用の `AudioOut` クラス
- 受信した WAV ファイルのヘッダーを解析する `WavReader` クラス（`WavStream` のみ）

API 自体は可能な限り ECMA-419 スタイルに従っており、完全な HTTP 構成（必要なコンストラクタを含む）とすべてのコールバックを渡します。

`AudioOut` インスタンスは呼び出しスクリプトによって提供され、再生に使用するストリームインデックスも指定されます。これにより、残りのストリームは他のオーディオ（追加の `WavStream` や `SBCStream` インスタンスを含む）に利用可能なままになります。

以下は、`WavStream` を使用してストリームを再生する簡単な例です。

```js
const audio = new AudioOut({});

new WavStream({
	http: device.network.http,
	host: "www.example.com",
	path: "/myaudio_11025.wav",
	audio: {
		out: audio
	}
});

audio.start();
```

代わりに SBC をストリームするには、コンストラクタを `WavStream` から `SBCStream` に変更し、SBC オーディオストリームの `path` プロパティを更新します。

ストリーマー API は、ストリーミングセッションを管理するためのいくつかのコールバックを提供しており、ストリーミングの停止や再生完了の通知を含みます。コールバックは、コンストラクタのオプションオブジェクトの一部として以下に記載されています。

ストリーマーは、オーディオ出力に1秒分のオーディオバッファをキューに入れるようにします。1秒分のオーディオがバッファされると、再生が始まります。バッファされたバイトが0になると、再生は再び1秒分のオーディオがバッファされるまで停止します。

## `Audio/L16` ストリーム
非圧縮オーディオストリームは、サンプルレートとチャンネル数がMIMEタイプで指定されたWAVEファイルのデータ部分です。これらは非圧縮オーディオのライブストリーミングに便利で、圧縮データを軽量クライアントにライブトランスコードするためにも使用されます。これは[RFC 2586](https://datatracker.ietf.org/doc/html/rfc2586)によって指定されています。データはネットワークバイトオーダー（ビッグエンディアン）で配信され、WavStreamerがそれをリトルエンディアンに変換して再生します。

次のコマンドラインは、ffmpegを使用してAudio/L16ストリーミングのテスト用の簡単なサーバーとして使用する方法を示しています：

```
ffmpeg -i bflatmajor.wav -listen 1 -content_type "audio/L16;rate=11025&channels=1" -f s16be -ar 11025 -acodec -ac 1 pcm_s16be http://127.0.0.1:8080
```

### SBC ストリーム
SBCオーディオファイルは、ヘッダーや追加のフレーミングなしでSBCオーディオフレームのシーケンスです。次のコマンドラインは、任意のHTTPサーバーから配信できるSBCオーディオファイルを生成するためにffmpegを使用します。

```
ffmpeg -i bflatmajor.wav -ac 1 -ar 16000 -b:a 32k ~/bflatmajor.sbc
```

### ステレオストリーム
`WavStream`はステレオデータを受け取り、再生のためにモノラルに変換します。これは既存のオーディオソースとの互換性のために提供されていますが、ネットワーク帯域幅の最適な使用方法ではありません。

`SBCStream`はステレオデータを拒否します。

### アンダーフロー（停止）
ストリーミングの停止は避けられません。ストリーマーが再生するオーディオがなくなると、「準備ができていない」状態になります。`onReady`コールバックが提供されている場合、オーディオ再生が一時停止していることを示すために`false`が渡されます。ストリーマーは停止してもオーディオチャンネルを停止しません。これはすべてのオーディオストリームが停止してしまうためです。代わりに、停止中は再生のために少なくとも1秒分のオーディオを蓄積するまで、オーディオインスタンスにバッファをキューに入れません。スクリプトは、再生が停止したときに再生を停止し、オーディオ再生が再開するタイミングを制御することができます。

## APIリファレンス

### `constructor(options)`

オプションオブジェクトには以下のプロパティを含めることができます。`http`、`host`、`path`、および`audio.out`プロパティは必須です。

- `http` - HTTPクライアントの設定。通常、これはホストプロバイダから `device.network.http` によって提供されます
- `host` - ストリームを接続するHTTPホスト
- `port` - 接続するリモートポート
- `path` - ストリームするHTTPリソースのパス
- `request` - 追加の[HTTPリクエスト](../../../../documentation/network/network.md#http-request)オプション（`method`、`headers`、`body`など）を含むことができるオプションのオブジェクト。これらのオプションはHTTPクライアントに直接渡されます。指定されていない場合、デフォルトのオプションが使用されます。
- `audio.out` - オーディオを再生するためのオーディオ出力インスタンス
- `audio.stream` - オーディオを再生するために使用するオーディオ出力のストリーム番号。デフォルトは `0`。
- `waveHeaderBytes` - WAVヘッダーを解析する前にバッファするバイト数。デフォルトは `512`（`WavStream` のみサポート）
- `bufferDuration` - 再生中にバッファするオーディオの持続時間（ミリ秒）。この目標に達したときに再生が開始されます。デフォルトは `1000` ミリ秒。
- `onPlayed(buffer)` - オーディオ出力がオーディオバッファを処理した後に呼び出されるコールバック関数。`WavStream` の場合はオーディオが非圧縮され、`SBCStream` の場合はSBC圧縮されます。このコールバックは、再生中の非圧縮オーディオのRMSを計算するのに役立ちます。
- `onReady(ready)` - 再生を開始するのに十分なオーディオがバッファされたときに `true` で呼び出され、オーディオバッファのアンダーフローが発生して再生が一時停止したときに `false` で呼び出されるコールバック関数
- `onError(e)` - リモートエンドポイントの切断などの致命的なエラーが発生したときに呼び出されるコールバック関数
- `onDone()` - 完全なストリームが正常に再生されたときに呼び出されるコールバック関数

### `close()`

指定されたストリームの再生を停止し、すべてのリソースを解放します。
